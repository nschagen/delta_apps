#!/bin/bash

MYPWD=`pwd`
ROOT=$(readlink -f ${LLVMAPPS_ROOT-../..})

. ${ROOT}/apps/scripts/include/configure.llvm.inc

LLVM_LIBS=`build_llvm_libs $*`

# Add delta whitelist header to all compilation units
LLVMGOLD_CFLAGS="$LLVMGOLD_CFLAGS -I ${ROOT}/llvm/include -include delta/whitelist.h"

NEW_CONFIGURE_LINE='"linux-x86_64-llvm",	"'$LLVMGOLD_CC':'$LLVMGOLD_CFLAGS'::-D_REENTRANT::'$LLVM_LIBS' '$LLVMGOLD_LDFLAGS':SIXTY_FOUR_BIT_LONG RC4_CHUNK DES_INT DES_UNROLL:${x86_64_asm}:elf::::::'$LLVMGOLD_RANLIB'::64",'

sed -i "/\"linux-x86_64-llvm\"/d" Configure
sed -i "/\"linux-x86_64\"/ a $NEW_CONFIGURE_LINE" Configure

sed -i "s|^CC=.*$|CC=$LLVMGOLD_CC|" Makefile.org
sed -i "s|^CFLAG=.*$|CFLAG=$LLVMGOLD_CFLAGS|" Makefile.org
sed -i "s|^MAKEDEPPROG=|MAKEDEPPROG=\$(CC) -MD|" Makefile.org
sed -i "s|^AR=.*$|AR=ar $LLVMGOLD_AR_FLAGS|" Makefile.org

./Configure no-shared no-asm no-engines --prefix=$MYPWD/install --openssldir=$MYPWD/install/ssl linux-x86_64-llvm

sed -i "s|\*\/lib \*\/\*\/lib||g" Makefile
